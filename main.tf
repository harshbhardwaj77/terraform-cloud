provider "google" {
  project     = var.project_id
  region      = var.region
  credentials = jsondecode(base64decode("ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAic3lsdmFuLWh5ZHJhLTQ2NDYwOC1wMyIsCiAgInByaXZhdGVfa2V5X2lkIjogIjNhNGU1YjMxNzZiNmExOTkyMTRlMTA1NjFjMTA3NTg0MTY2ZjA0ODIiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cbk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRQzdUZlVmdWMwMzlZYThcbjFBUkxlcDBNUWRLNGtSR0UvQXJlclZjeHlWUDhyeTBsN1lCRUhzdDM0WDk3UmdxSUd4cFphU3FEbVFmbVZBRDNcbmRsZzVtcHFQcjczTUV2NWtCdHN6blhBMW5zK2pOY1Mxand0TGhiR1I3aXhLSDFHUmhRbTBVQk5XZE5hOTNzYVRcbjhrWTdwVnV6bVJqalpjRUFvK2RsRXdoQjQ3ZU1LdlM4Zkp5QU82QmRvRjFYalg2MkRmSE1FcngvT09GQ1VBdDRcblFrZXNjeElyQ2p6RVRUTldjL1RkN2Q2Q1o4cHdBNi9GbDBmejdwcElLbnJKbTB4TzJrV2FQNExnOHpnbU1uNUhcbmgyb1BzenRjb3FHalUwRlJpVDRYMndtNGtBemF4S0JTWDI3bWtCWkRFYmFUNDBWK1VuRFgvSkZsTU9MdFZiUEtcblJJYW5UejBsQWdNQkFBRUNnZ0VBQ2c2cWpkU05OMmNBb0IwR1NnTkFjWXNMUkl2TmxBVndrL3BjeHppWFFPY3JcbkZuRkZST01lYThaNDhPYVc1QzRJWVNxcmRMdC8yQmRFb2dVQndiNFNkSXFzTjB3Qnl0OHZYL3NoTGsvanVGREhcbnlqUHZHRlFLYjlxSkdFWE1QSE1YVFU1TGE0WUVqZGRyZEVBN0V6TFMxTGJ3eGkwTml2cENENFJSR2pDZkIzQ2pcbmJIT3FOTGVNSmFVS3pFdGVPTmZpdExQQlN1b25Od0s2STNWZ3JGQzFRdW1Ya1lqd1FUKytoMHVTT0g1RTlsR3ZcbmYrcFNqQlVMMTIxemV0cW9TUUNzaTFDZXhZVXZRWDRFVjdLdkJQMGhaQVZ0YUd6eDJsTmZGbm1rZ2dVVDUxazdcbjdnNk5zM1JsWkpBOTdBK3NrYWFGMjlRWVAvMVdqYXBHNlBiNkN4Vk9sUUtCZ1FEdjJtQWY5WG9vdkRXb0NpdjZcbjUxYnhMOW85bVp1b0pmbjkxUEkveFAvS2tlSDMrUmVVYWtqdVVucFJSUGwwcjhGWnlsaFE1cmlISlpYSGQ2ZStcbmUvMlVGRXlCd01neGk4ZFplbnJsdzN5UEJUSk1YOUlvdGdQK1B2MEJLY1E1RmVFckd1OTJ5bzIyTnJic0t6dEpcbnd2L244OEFTQTBzM3BLTHJ4MjhvVFlMZFF3S0JnUURINmZZc1dKUGRQdFJnOW9IKzRiRzVmaVJxNms5eU5MWC9cbk9HaUprREtqTnkwdU81RnhxT0JVWWRVUnRaTXZYcnJSMDlSYkRQTW05ZmNQK3BJMUJlOGhzNHpjS05RSkdhS0VcblZ2b2gwaUd4dHNCNFZzRy9zSm5oTnBZV1FrdW1vbVZkaldQcEgydmU3SEhqb1Zzd08yekNlM3VRZU5lOEZxajlcbndSUGJ3NHhoZHdLQmdRREx0MDl6ZFh5SEFxd1VDR2VvV0RxbzZYclVYUll1NytwdnBDRUk5cHBIQkRiSDllSUlcbkpXbkNPWDA0YjN2c2xxYURTL0JNN2xtR04rOEtGdC83VXJaaXdnYmxJY2NuQmRDUWVBM1Avb1JadVJFcWV5dzFcbmRicllnOGxCNXFhSjBjS0lhUDFBaVBOcDh2alVpRGQ0QTg1MHhMdTYwTjllNkUrVU1MU0JwNnZobndLQmdRQ3ZcblVNVDdGTjd2T29kRFZVcWhQRW9Ba3RmYkR3cUc3Q1RpNGhRQzkzc0EyWVY4c3U2VXozV1Rhb3hSVUh2NEljb1Jcbjh3T2FxWnVmQWpzZFB5L3k0ZlpaQnIyejRQWTUyTXBGNW9UTEhoMUFYVFVqRTJvcjhmS3dwNDh0akF3TjRRS2xcbjdUVytIamthTVI2YmNraW0zcVk5VTg4RDNvWEt3OUNGWUVwTEFvMWNkd0tCZ0hkRDdEL2MyNXRlQlV3NUlYUzRcbnFOTmxIV2ZGR2NGTDUvOFVONlljcnB1alBTU3RyUmZ4RXhzTnFlalVMYkdQYjV2QjhqSXF4QTRoK3Qvbmw2RWhcbnNzcFY0L3dubGY1WGZtcVFQY08wMWpyczFDSVZCOHJ2WHduT0xkbG5NNjBXTG95bERVVWFLSmxINFNXSDc5YWNcbkhhL0dDUUNVcUYrL1NMTVdyb25XVTljUVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxuIiwKICAiY2xpZW50X2VtYWlsIjogImZ1bGwtYWNjZXNzQHN5bHZhbi1oeWRyYS00NjQ2MDgtcDMuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJjbGllbnRfaWQiOiAiMTE2MDkyMDk1NjA1MDA3MTc2MDMxIiwKICAiYXV0aF91cmkiOiAiaHR0cHM6Ly9hY2NvdW50cy5nb29nbGUuY29tL28vb2F1dGgyL2F1dGgiLAogICJ0b2tlbl91cmkiOiAiaHR0cHM6Ly9vYXV0aDIuZ29vZ2xlYXBpcy5jb20vdG9rZW4iLAogICJhdXRoX3Byb3ZpZGVyX3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vb2F1dGgyL3YxL2NlcnRzIiwKICAiY2xpZW50X3g1MDlfY2VydF91cmwiOiAiaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vcm9ib3QvdjEvbWV0YWRhdGEveDUwOS9mdWxsLWFjY2VzcyU0MHN5bHZhbi1oeWRyYS00NjQ2MDgtcDMuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLAogICJ1bml2ZXJzZV9kb21haW4iOiAiZ29vZ2xlYXBpcy5jb20iCn0K"))
}

resource "google_compute_instance" "web" {
  name         = "terraform"
  machine_type = "e2-medium"
  zone         = var.zone

  boot_disk {
    initialize_params {
      image = "ubuntu-2204-lts"
    }
  }

  network_interface {
    network = "default"
    access_config {}
  }

  metadata_startup_script = file("scripts/setup.sh")

  tags = ["web"]

  # SSH connection for remote exec
  connection {
    type        = "ssh"
    user        = "ubuntu"
    private_key = file(var.ssh_private_key)
    host        = self.network_interface[0].access_config[0].nat_ip
  }

  # Install based on user input
  provisioner "remote-exec" {
    inline = [
      "chmod +x /tmp/setup.sh",
      "sudo /tmp/setup.sh ${var.app_type}"
    ]
  }

  provisioner "file" {
    source      = "scripts/setup.sh"
    destination = "/tmp/setup.sh"
  }
}
